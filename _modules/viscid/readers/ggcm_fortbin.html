

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>viscid.readers.ggcm_fortbin &mdash; Viscid 0.60.0 dev documentation</title>
  

  
  

  
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700' rel='stylesheet' type='text/css'>

  
  

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'../../../',
        VERSION:'0.60.0 dev',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
      };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
    <link rel="top" title="Viscid 0.60.0 dev documentation" href="../../../index.html"/>
        <link rel="up" title="viscid.readers" href="../readers.html"/> 

  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../../index.html" class="icon icon-home"> Viscid</a>
        <form class="wy-form" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search docs" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#standard-setup">Standard Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#for-developers">For Developers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../philosophy.html">Philosophy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../philosophy.html#data-abstraction">Data Abstraction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ex_reader.html">Reading/Plotting Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_reader.html#super-simple">Super Simple</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_reader.html#two-plots-one-figure">Two Plots, One Figure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_reader.html#playing-with-time">Playing with Time</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_reader.html#slicing-fields">Slicing Fields</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ex_openggcm.html">OpenGGCM Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_openggcm.html#gse-coordinates">GSE coordinates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_openggcm.html#ionosphere-files">Ionosphere Files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ex_calc.html">Calculator Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_calc.html#streamlines">Streamlines</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../command_line.html">Command Line Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../command_line.html#p2d">p2d</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../command_line.html#viscid-diff">viscid_diff</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../command_line.html#bitmaskbits">bitmaskbits</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../viscid.html">viscid package</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="/">Viscid</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <ul class="wy-breadcrumbs">
  <li><a href="../../../index.html">Docs</a> &raquo;</li>
  <li><a href="">viscid.readers.ggcm_fortbin</a></li>
  
</ul>
<hr/>

          
  <h1>Source code for viscid.readers.ggcm_fortbin</h1><pre>
from __future__ import print_function
import struct
try:
    from collections import OrderedDict
except ImportError:
    from viscid.compat import OrderedDict

import numpy as np

from viscid import field
from viscid import grid
from viscid.readers import vfile
from viscid.readers import openggcm


# raise NotImplementedError("fortbin reader is not at all")


<div class="viewcode-block" id="GGCMFileFortbinMHD"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.GGCMFileFortbinMHD">[docs]</a>class GGCMFileFortbinMHD(openggcm.GGCMFileFortran):  # pylint: disable=abstract-method
    """Jimmy's run length encoding files"""
    _detector = r"^\s*(.*)\.(p[xyz]_[0-9]+|3df)" \
                r"\.([0-9]{6})b\s*$"

    _file_wrapper = None
    _data_item_templates = None
    _def_fld_center = "Cell"

    def __init__(self, filename, vfilebucket=None, **kwargs):
        super(GGCMFileFortbinMHD, self).__init__(filename, vfilebucket, **kwargs)

    def _parse_file(self, filename):
        # we do minimal file parsing here for performance. we just
        # make data wrappers from the templates we got from the first
        # file in the group, and package them up into grids

        # find the time from the first field's meta data
        self._file_wrapper = GGCMFortbinFileWrapper(filename)

        timestr = self._file_wrapper.file_meta['timestr']
        time = float(str(timestr)[6:].split()[0])

        _grid = self._grid_type("&lt;FortbinGrid&gt;", **self._grid_opts)
        self.time = time
        _grid.time = time
        _grid.set_crds(self._crds)

        templates = self._fld_templates
        if templates is None:
            templates = self._make_template(filename)

        # make a DataWrapper and a Field for each template that we
        # have from the first file that we parsed, then add it to
        # the _grid
        if self._iono:
            data_wrapper = FortbinDataWrapper
        else:
            data_wrapper = FortbinDataWrapper

        for item in templates:
            data = data_wrapper(self._file_wrapper, item['fld_name'],
                                item['shape'])
            fld = field.wrap_field("Scalar", item['fld_name'], self._crds,
                                   data, center=self._def_fld_center,
                                   time=time)
            _grid.add_field(fld)
        return _grid

    @staticmethod
    def _make_template(filename):
        """read meta data for all fields in a file to get
        a list of field names and shapes, all the required info
        to make a FortbinDataWrapper
        """
        with GGCMFortbinFileWrapper(filename) as f:
            f.inquire_all_fields()
            template = []
            for fld_name, meta in f.fields_seen.items():
                d = dict(fld_name=fld_name,
                         shape=meta['dims'])
                template.append(d)
        return template

</div>
<div class="viewcode-block" id="GGCMFileFortbinIono"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.GGCMFileFortbinIono">[docs]</a>class GGCMFileFortbinIono(GGCMFileFortbinMHD):  # pylint: disable=abstract-method
    """Jimmy's run length encoding files"""
    _detector = r"^\s*(.*)\.(iof)\.([0-9]{6})b\s*$"
    _iono = True
    _grid_type = grid.Grid
    _def_fld_center = "Node"

</div>
<div class="viewcode-block" id="GGCMFortbinFileWrapper"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.GGCMFortbinFileWrapper">[docs]</a>class GGCMFortbinFileWrapper(object):
    """A File-like object for interfacing with OpenGGCM binary files"""
    _file = None
    _endian = None

    filename = None
    _file_meta = None
    fields_seen = None
    seen_all_fields = None

    def __init__(self, filename):
        self.filename = filename
        self.fields_seen = OrderedDict()
        self.seen_all_fields = False

    def __del__(self):
        self.close()

    @property
<div class="viewcode-block" id="GGCMFortbinFileWrapper.file_meta"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.GGCMFortbinFileWrapper.file_meta">[docs]</a>    def file_meta(self):
        if self._file_meta is None:
            with self as _:
                # just opening the file makes it read the meta data
                pass
        return self._file_meta
</div>
<div class="viewcode-block" id="GGCMFortbinFileWrapper.read_field"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.GGCMFortbinFileWrapper.read_field">[docs]</a>    def read_field(self, fld_name):
        """Read a field given a seekable location

        Parameters:
            loc(int): position in file we can seek to

        Returns:
            tuple (field name, dict of meta data, array)
        """
        meta = self.inquire(fld_name)
        self._file.seek(meta['file_position'] + meta['header_size'])

        data = np.fromfile(self._file, dtype=np.dtype(self._endian + 'f'),
                           count=meta.nelem)
        return meta, data.reshape(meta['dims'], order='F')
</div>
<div class="viewcode-block" id="GGCMFortbinFileWrapper.inquire_all_fields"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.GGCMFortbinFileWrapper.inquire_all_fields">[docs]</a>    def inquire_all_fields(self, reinquire=False):
        if reinquire:
            self.seen_all_fields = False
            self.fields_seen = OrderedDict()

        if self.seen_all_fields:
            return

        self.rewind()
        while not self.seen_all_fields:
            self.inquire_next()
            self._file.seek(self.file_meta['nbytes'], whence=1)
</div>
<div class="viewcode-block" id="GGCMFortbinFileWrapper.inquire"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.GGCMFortbinFileWrapper.inquire">[docs]</a>    def inquire(self, fld_name):
        try:
            meta = self.fields_seen[fld_name]
            self.seek(meta['file_position'])
            return meta
        except KeyError:
            last_added = next(reversed(self.fields_seen))
            # go to the last seen field and go one field past it
            self.seek(self.fields_seen[last_added]['file_position'] +
                      self.file_meta['nbytes'])

            while not self.seen_all_fields:
                found_fld_name, meta = self.inquire_next()
                if found_fld_name == fld_name:
                    return meta
                self._file.seek(self.file_meta['nbytes'], whence=1)

            raise KeyError("file '{0}' has no field '{1}'".format(
                           self.filename, fld_name))
</div>
<div class="viewcode-block" id="GGCMFortbinFileWrapper.inquire_next"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.GGCMFortbinFileWrapper.inquire_next">[docs]</a>    def inquire_next(self):
        """Collect the meta-data from the next field in the file

        Returns:
            tuple (field name, dict of meta data) both
            of which will be None if there are no more Fields

        Note:
            After this operation is done, the file-pointer will be reset
            to the position it was before the inquiry.
        """
        if not self.isopen:
            raise RuntimeError("file is not open")

        fld_name, meta = self._read_header()

        if not fld_name:
            self.seen_all_fields = True
            return None, None

        if fld_name not in self.fields_seen:
            self.fields_seen[fld_name] = meta

        return fld_name, meta
</div>
<div class="viewcode-block" id="GGCMFortbinFileWrapper.open"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.GGCMFortbinFileWrapper.open">[docs]</a>    def open(self):
        if self._file is None:
            self._file = open(self.filename, 'rb')
            try:
                if self._endian is None or self._file_meta is None:
                    self._read_file_header()
            except IOError as e:
                self.close()
                raise e
</div>
    @property
<div class="viewcode-block" id="GGCMFortbinFileWrapper.isopen"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.GGCMFortbinFileWrapper.isopen">[docs]</a>    def isopen(self):
        return self._file is not None
</div>
<div class="viewcode-block" id="GGCMFortbinFileWrapper.close"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.GGCMFortbinFileWrapper.close">[docs]</a>    def close(self):
        f = self._file
        self._file = None
        f.close()
</div>
    def __enter__(self):
        self.open()
        return self

    def __exit__(self, typ, value, traceback):
        self.close()

    def _read_file_header(self, data_size=4):
        """load up the file's meta data"""
        assert self._file.tell() == 0
        _, meta = self._read_header(data_size=data_size)
        self._file_meta = meta

    def _read_header(self, data_size=4):
        """read a field's header; returns None, None if EOF"""
        if not self.isopen:
            raise RuntimeError("Trying to read header, but file is closed.")

        try:
            pos = self._file.tell()
            endian_marker = self._file.read(4) #Read an integer.  Unpack it
            if endian_marker == struct.pack('&lt;i', 2):
                self._endian = '&lt;'
            elif endian_marker == struct.pack('&gt;i', 2):
                self._endian = '&gt;'
            else:
                raise IOError("Can't detect endian, not a fortbin file: "
                              "{0}".format(self.fname))

            inttime = struct.unpack(self._endian + 'i', self._file.read(4))[0]
            ndim = struct.unpack(self._endian + 'i', self._file.read(4))[0]
            dims = struct.unpack(self._endian + '{0}i'.format(ndim),
                                 self._file.read(4 * ndim))

            fld_name = self._file.read(80).decode().strip()
            asciitime = self._file.read(80).decode()

            header_size = 4 + 4 + 4 + (4 * ndim) + (2 * 80)
            nelem = np.prod(dims)
            nbytes = header_size + data_size * nelem

            fld_meta = dict(header_size=header_size,
                            timestr=asciitime,
                            inttime=inttime,
                            ndim=ndim,
                            dims=dims,
                            nelem=nelem,
                            nbytes=nbytes)
            self._file.seek(pos)

            if fld_name == "":
                return None, None
            else:
                return fld_name, fld_meta
        except struct.error:
            return None, None
</div>
<div class="viewcode-block" id="FortbinDataWrapper"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.FortbinDataWrapper">[docs]</a>class FortbinDataWrapper(vfile.DataWrapper):
    """  """
    file_wrapper = None
    filename = None
    fld_name = None
    expected_shape = None

    def __init__(self, file_wrapper, fld_name, expected_shape):
        """Lazy wrapper for a field in a Fortbin file

        Parameters:
            expected_shape (tuple): shape of data in the file (xyz)
        """
        super(FortbinDataWrapper, self).__init__()
        self.file_wrapper = file_wrapper
        self.filename = file_wrapper.filename
        self.fld_name = fld_name
        # translate to zyx
        self.expected_shape = expected_shape

    @property
<div class="viewcode-block" id="FortbinDataWrapper.shape"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.FortbinDataWrapper.shape">[docs]</a>    def shape(self):
        """
        Returns:
            zyx shape since that's the shape __array__ returns
        """
        return self.expected_shape[::-1]
</div>
    @property
<div class="viewcode-block" id="FortbinDataWrapper.dtype"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.FortbinDataWrapper.dtype">[docs]</a>    def dtype(self):
        return np.dtype("float32")
</div>
    def __array__(self, *args, **kwargs):
        with self.file_wrapper as f:
            ndim = len(self.expected_shape)
            # fld_name, meta, arr = f.read_field_at(self.loc, ndim)
            meta, arr = f.read_field(self.fld_name, ndim)
            arr = np.array(arr.flatten(order='F').reshape(meta['dims'][::-1]),
                           order='C')

        # meta's dims are xyz (from file), but ex
        if meta['dims'] != self.expected_shape:
            raise RuntimeError("Field '{0}' from file '{1}' has shape {2} "
                               "instead of {3}".format(self.fld_name,
                               self.filename, meta['dims'],
                               self.expected_shape))
        return arr.astype(self.dtype)

<div class="viewcode-block" id="FortbinDataWrapper.read_direct"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.FortbinDataWrapper.read_direct">[docs]</a>    def read_direct(self, *args, **kwargs):
        return self.__array__()
</div>
<div class="viewcode-block" id="FortbinDataWrapper.len"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_fortbin.FortbinDataWrapper.len">[docs]</a>    def len(self):
        return self.shape[0]
</div>
    def __getitem__(self, item):
        return self.__array__().__getitem__(item)


# class FortbinIonoDataWrapper(FortbinDataWrapper):
#     @property
#     def shape(self):
#         ret = tuple([n - 1 for n in reversed(self.expected_shape)])
#         return ret

#     def __array__(self, *args, **kwargs):
#         arr = super(FortbinIonoDataWrapper, self).__array__(*args, **kwargs)
#         ndim = len(self.expected_shape)
#         return arr[[slice(None, -1)]*ndim]

##
## EOF
##</div>
</pre>

          <footer>
  <hr/>

  <p>
      &copy; Copyright 2013, Kristofor Maynard.
  </p>

  <a href="https://www.github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="http://www.readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  

</body>
</html>
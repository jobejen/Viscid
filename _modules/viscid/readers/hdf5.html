<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>viscid.readers.hdf5 &mdash; Viscid 0.50.2 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.50.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Viscid 0.50.2 documentation" href="../../../index.html" />
    <link rel="up" title="viscid.readers" href="../readers.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Viscid 0.50.2 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../readers.html" accesskey="U">viscid.readers</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for viscid.readers.hdf5</h1><pre>
from __future__ import print_function
import os
import logging

import numpy as np
try:
    import h5py
    HAS_H5PY = True
except ImportError:
    HAS_H5PY = False
    logging.warn("h5py library not found, no hdf5 support.")

from . import vfile

<div class="viewcode-block" id="H5pyDataWrapper"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.hdf5.H5pyDataWrapper">[docs]</a>class H5pyDataWrapper(vfile.DataWrapper):
    """  """
    fname = None
    loc = None

    _shape = None
    _dtype = None

    def __init__(self, fname, loc):
        super(H5pyDataWrapper, self).__init__()
        self.fname = fname
        self.loc = loc

    def _get_info(self):
        # this takes super long when reading 3 hrs worth of ggcm data
        # over sshfs
        # import pdb; pdb.set_trace()
        try:
            with h5py.File(self.fname, 'r') as f:
                dset = f[self.loc]
                self._shape = dset.shape
                self._dtype = dset.dtype
        except IOError as e:
            logging.error("Problem opening hdf5 file, '{0}'".format(self.fname))
            raise e

    @property
<div class="viewcode-block" id="H5pyDataWrapper.shape"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.hdf5.H5pyDataWrapper.shape">[docs]</a>    def shape(self):
        """ only ask for this if you really need it; can be a speed problem
        for large temporal datasets over sshfs """
        if self._shape is None:
            self._get_info()
        return self._shape
</div>
    @property
<div class="viewcode-block" id="H5pyDataWrapper.dtype"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.hdf5.H5pyDataWrapper.dtype">[docs]</a>    def dtype(self):
        """ only ask for this if you really need it; can be a speed problem
        for large temporal datasets over sshfs """
        if self._dtype is None:
            self._get_info()
        return self._dtype
</div>
<div class="viewcode-block" id="H5pyDataWrapper.wrap_func"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.hdf5.H5pyDataWrapper.wrap_func">[docs]</a>    def wrap_func(self, func_name, *args, **kwargs):
        with h5py.File(self.fname, 'r') as f:
            return getattr(f[self.loc], func_name)(*args, **kwargs)
</div>
    def __array__(self, *args, **kwargs):
        return self.wrap_func("__array__", *args, **kwargs)

<div class="viewcode-block" id="H5pyDataWrapper.read_direct"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.hdf5.H5pyDataWrapper.read_direct">[docs]</a>    def read_direct(self, *args, **kwargs):
        return self.wrap_func("read_direct", *args, **kwargs)
</div>
<div class="viewcode-block" id="H5pyDataWrapper.len"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.hdf5.H5pyDataWrapper.len">[docs]</a>    def len(self):
        return self.wrap_func("len")
</div>
    def __getitem__(self, item):
        return self.wrap_func("__getitem__", item)

</div>
<div class="viewcode-block" id="FileLazyHDF5"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.hdf5.FileLazyHDF5">[docs]</a>class FileLazyHDF5(vfile.VFile):
    """ This is for lazy wrapping an h5 file referred to by an xdmf file,
    or anything else where you want to have a single file instance for a single
    hdf5 file, but you don't want any parsing because you already know what's
    going to be in the file. """
    _detector = None

    def __init__(self, fname, **kwargs):
        assert(HAS_H5PY)
        super(FileLazyHDF5, self).__init__(fname, **kwargs)

    def _parse(self):
        pass

<div class="viewcode-block" id="FileLazyHDF5.get_data"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.hdf5.FileLazyHDF5.get_data">[docs]</a>    def get_data(self, handle):
        return H5pyDataWrapper(self.fname, handle)

</div></div>
<div class="viewcode-block" id="FileHDF5"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.hdf5.FileHDF5">[docs]</a>class FileHDF5(vfile.VFile): #pylint: disable=R0922
    """ this is an abstract-ish class from which other types of hdf5 readers
    should derrive """
    _detector = r".*\.h5\s*$"

    _CRDS_GROUP = "/crds"
    _FLD_GROUPS = {"node": "/flds_nc",
                   "cell": "/flds_cc",
                   "face": "/flds_fc",
                   "edge": "/flds_ec"}

    _XDMF_TEMPLATE_BEGIN = \
"""&lt;?xml version='1.0' ?&gt;
&lt;Xdmf xmlns:xi='http://www.w3.org/2001/XInclude' Version='2.0'&gt;
&lt;Domain&gt;
&lt;Grid GridType="Collection" CollectionType="Spatial"&gt;
  &lt;Time Type="Single" Value="{time}" /&gt;
"""
    _XDMF_TEMPLATE_RECTILINEAR_GRID_BEGIN = \
"""  &lt;Grid Name="{grid_name}" GridType="Uniform"&gt;
    &lt;Topology TopologyType="3DRectMesh" Dimensions="{crd_dims}"/&gt;
    &lt;Geometry GeometryType="VXVYVZ"&gt;
    &lt;DataItem Name="VX" DataType="Float" Dimensions="{xdim}" Format="HDF"&gt;
       {h5fname}:{xloc}
    &lt;/DataItem&gt;
    &lt;DataItem Name="VY" DataType="Float" Dimensions="{ydim}" Format="HDF"&gt;
       {h5fname}:{yloc}
    &lt;/DataItem&gt;
    &lt;DataItem Name="VZ" DataType="Float" Dimensions="{zdim}" Format="HDF"&gt;
       {h5fname}:{zloc}
    &lt;/DataItem&gt;
    &lt;/Geometry&gt;
"""
    _XDMF_TEMPLATE_ATTRIBUTE = \
"""    &lt;Attribute Name="{fld_name}" AttributeType="{fld_type}" Center="{center}"&gt;
      &lt;DataItem Dimensions="{fld_dims}" NumberType="{dtype}" Precision="{precision}" Format="HDF"&gt;
        {h5fname}:{fld_loc}
      &lt;/DataItem&gt;
    &lt;/Attribute&gt;
"""
    _XDMF_TEMPLATE_GRID_END = \
"""  &lt;/Grid&gt;
"""
    _XDMF_TEMPLATE_END = \
"""&lt;/Grid&gt;
&lt;/Domain&gt;
&lt;/Xdmf&gt;
"""

    def __init__(self, fname, **kwargs):
        assert(HAS_H5PY)
        super(FileHDF5, self).__init__(fname, **kwargs)

    def _parse(self):
        raise NotImplementedError("Please load using the xdmf file")

<div class="viewcode-block" id="FileHDF5.save"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.hdf5.FileHDF5.save">[docs]</a>    def save(self, fname=None, **kwargs):
        """ save an instance of VFile, fname defaults to the name
        of the file object as read """
        if fname is None:
            fname = self.fname
        flds = list(self.iter_fields)
        self.save_fields(fname, flds)
</div>
    @classmethod
<div class="viewcode-block" id="FileHDF5.save_fields"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.hdf5.FileHDF5.save_fields">[docs]</a>    def save_fields(cls, fname, flds, **kwargs):
        """ save some fields using the format given by the class """
        # FIXME: this is only good for writing cartesian rectilnear flds
        # FIXME: axes are renamed if flds[0] is 1D or 2D
        assert(len(flds) &gt; 0)
        fname = os.path.expanduser(os.path.expandvars(fname))

        clist = flds[0].crds.get_clist()
        crd_arrs = [np.array([0.0])] * 3
        crd_names = ["z", "y", "x"]
        for i, c in enumerate(clist):
            crd_arrs[i] = c[1]
        crd_shape = [len(arr) for arr in crd_arrs]
        time = flds[0].time

        # write arrays to the hdf5 file
        with h5py.File(fname, 'w') as f:
            for axis_name, arr in zip(crd_names, crd_arrs):
                loc = cls._CRDS_GROUP + '/' + axis_name
                f[loc] = arr

            for fld in flds:
                loc = cls._FLD_GROUPS[fld.center.lower()] + '/' + fld.name
                f[loc] = fld.data

        # now write an xdmf file
        xdmf_fname = os.path.splitext(fname)[0] + ".xdmf"
        relh5fname = "./" + os.path.basename(fname)
        with open(xdmf_fname, 'w') as f:
            xloc = cls._CRDS_GROUP + '/' + crd_names[2]
            yloc = cls._CRDS_GROUP + '/' + crd_names[1]
            zloc = cls._CRDS_GROUP + '/' + crd_names[0]
            dim_str = " ".join([str(l) for l in crd_shape])
            f.write(cls._XDMF_TEMPLATE_BEGIN.format(time=time))
            f.write(cls._XDMF_TEMPLATE_RECTILINEAR_GRID_BEGIN.format(
                    grid_name="vgrid", crd_dims=dim_str, h5fname=relh5fname,
                    xdim=crd_shape[2], ydim=crd_shape[1], zdim=crd_shape[0],
                    xloc=xloc, yloc=yloc, zloc=zloc))

            for fld in flds:
                dt = fld.dtype.name.rstrip("0123456789").title()
                precision = fld.dtype.itemsize
                fld_dim_str = " ".join([str(l) for l in fld.shape])
                loc = cls._FLD_GROUPS[fld.center.lower()] + '/' + fld.name
                f.write(cls._XDMF_TEMPLATE_ATTRIBUTE.format(fld_name=fld.name,
                        fld_type=fld.type, center=fld.center.title(),
                        dtype=dt, precision=precision, fld_dims=fld_dim_str,
                        h5fname=relh5fname, fld_loc=loc))

            f.write(cls._XDMF_TEMPLATE_GRID_END)
            f.write(cls._XDMF_TEMPLATE_END)

##
## EOF
##</div></div>
</pre>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Viscid 0.50.2 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../readers.html" >viscid.readers</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Kristofor Maynard.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.1.
    </div>
  </body>
</html>
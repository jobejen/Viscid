

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>viscid.readers.ggcm_jrrle &mdash; Viscid 0.60.0 documentation</title>
  

  
  

  
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700' rel='stylesheet' type='text/css'>

  
  

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'../../../',
        VERSION:'0.60.0',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
      };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
    <link rel="top" title="Viscid 0.60.0 documentation" href="../../../index.html"/>
        <link rel="up" title="viscid.readers" href="../readers.html"/> 

  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../../index.html" class="icon icon-home"> Viscid</a>
        <form class="wy-form" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search docs" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#standard-setup">Standard Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#for-developers">For Developers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../philosophy.html">Philosophy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../philosophy.html#data-abstraction">Data Abstraction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ex_reader.html">Reading/Plotting Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_reader.html#super-simple">Super Simple</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_reader.html#two-plots-one-figure">Two Plots, One Figure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_reader.html#playing-with-time">Playing with Time</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_reader.html#slicing-fields">Slicing Fields</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ex_openggcm.html">OpenGGCM Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_openggcm.html#gse-coordinates">GSE coordinates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_openggcm.html#ionosphere-files">Ionosphere Files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ex_calc.html">Calculator Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ex_calc.html#streamlines">Streamlines</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../command_line.html">Command Line Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../command_line.html#p2d">p2d</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../command_line.html#viscid-diff">viscid_diff</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../command_line.html#bitmaskbits">bitmaskbits</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../viscid.html">viscid package</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="/">Viscid</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <ul class="wy-breadcrumbs">
  <li><a href="../../../index.html">Docs</a> &raquo;</li>
  <li><a href="">viscid.readers.ggcm_jrrle</a></li>
  
</ul>
<hr/>

          
  <h1>Source code for viscid.readers.ggcm_jrrle</h1><pre>
from __future__ import print_function
import os
import re
try:
    from collections import OrderedDict
except ImportError:
    from viscid.compat import OrderedDict

import numpy as np

from viscid import field
from viscid import grid
from viscid.readers import vfile
from viscid.readers import openggcm
from viscid.readers._fortfile_wrapper import FortranFile
from viscid.readers import _jrrle


<div class="viewcode-block" id="GGCMFileJrrleMHD"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_jrrle.GGCMFileJrrleMHD">[docs]</a>class GGCMFileJrrleMHD(openggcm.GGCMFileFortran):  # pylint: disable=abstract-method
    """Jimmy's run length encoding files"""
    _detector = r"^\s*(.*)\.(p[xyz]_[0-9]+|3df)" \
                r"\.([0-9]{6})\s*$"

    _file_wrapper = None
    _data_item_templates = None
    _def_fld_center = "Cell"

    def __init__(self, filename, vfilebucket=None, **kwargs):
        super(GGCMFileJrrleMHD, self).__init__(filename, vfilebucket, **kwargs)

    def _parse_file(self, filename):
        # we do minimal file parsing here for performance. we just
        # make data wrappers from the templates we got from the first
        # file in the group, and package them up into grids

        # find the time from the first field's meta data
        self._file_wrapper = JrrleFileWrapper(filename)

        with self._file_wrapper as f:
            _, meta = f.inquire_next()
            time = float(str(meta['timestr'])[6:].split()[0])

        _grid = self._grid_type("&lt;JrrleGrid&gt;", **self._grid_opts)
        self.time = time
        _grid.time = time
        _grid.set_crds(self._crds)

        templates = self._fld_templates
        if templates is None:
            templates = self._make_template(filename)

        # make a DataWrapper and a Field for each template that we
        # have from the first file that we parsed, then add it to
        # the _grid
        if self._iono:
            data_wrapper = JrrleDataWrapper
        else:
            data_wrapper = JrrleDataWrapper

        for item in templates:
            data = data_wrapper(self._file_wrapper, item['fld_name'],
                                item['shape'])
            fld = field.wrap_field("Scalar", item['fld_name'], self._crds,
                                   data, center=self._def_fld_center,
                                   time=time)
            _grid.add_field(fld)
        return _grid

    @staticmethod
    def _make_template(filename):
        """read meta data for all fields in a file to get
        a list of field names and shapes, all the required info
        to make a JrrleDataWrapper
        """
        with JrrleFileWrapper(filename) as f:
            f.inquire_all_fields()
            template = []
            for fld_name, meta in f.fields_seen.items():
                d = dict(fld_name=fld_name,
                         shape=meta['dims'])
                template.append(d)
        return template

    @classmethod
<div class="viewcode-block" id="GGCMFileJrrleMHD.collective_name_from_group"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_jrrle.GGCMFileJrrleMHD.collective_name_from_group">[docs]</a>    def collective_name_from_group(cls, fnames):
        fname0 = fnames[0]
        basename = os.path.basename(fname0)
        run = re.match(cls._detector, basename).group(1)
        fldtype = re.match(cls._detector, basename).group(2)
        new_basename = "{0}.{1}".format(run, fldtype)
        return os.path.join(os.path.dirname(fname0), new_basename)

</div></div>
<div class="viewcode-block" id="GGCMFileJrrleIono"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_jrrle.GGCMFileJrrleIono">[docs]</a>class GGCMFileJrrleIono(GGCMFileJrrleMHD):  # pylint: disable=abstract-method
    """Jimmy's run length encoding files"""
    _detector = r"^\s*(.*)\.(iof)\.([0-9]{6})\s*$"
    _iono = True
    _grid_type = grid.Grid
    _def_fld_center = "Node"
</div>
<div class="viewcode-block" id="JrrleFileWrapper"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_jrrle.JrrleFileWrapper">[docs]</a>class JrrleFileWrapper(FortranFile):
    """Interface for actually opening / reading a jrrle file"""
    _read_func = [_jrrle.read_jrrle1d, _jrrle.read_jrrle2d,
                  _jrrle.read_jrrle3d]

    fields_seen = None
    seen_all_fields = None

    def __init__(self, filename):
        self.fields_seen = OrderedDict()
        self.seen_all_fields = False
        super(JrrleFileWrapper, self).__init__(filename)

<div class="viewcode-block" id="JrrleFileWrapper.read_field"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_jrrle.JrrleFileWrapper.read_field">[docs]</a>    def read_field(self, fld_name, ndim):
        """Read a field given a seekable location

        Parameters:
            loc(int): position in file we can seek to
            ndim(int): dimensionality of field

        Returns:
            tuple (field name, dict of meta data, array)
        """
        meta = self.inquire(fld_name)
        arr = np.empty(meta['dims'], dtype='float32', order='F')
        self._read_func[ndim - 1](self.unit, arr, fld_name)
        return meta, arr
</div>
<div class="viewcode-block" id="JrrleFileWrapper.inquire_all_fields"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_jrrle.JrrleFileWrapper.inquire_all_fields">[docs]</a>    def inquire_all_fields(self, reinquire=False):
        if reinquire:
            self.seen_all_fields = False
            self.fields_seen = OrderedDict()

        if self.seen_all_fields:
            return

        self.rewind()
        while not self.seen_all_fields:
            self.inquire_next()
            # last_seen, meta = self.inquire_next()
            # if meta is not None:
            #     print(last_seen, "lives at", meta["file_position"])
            self.advance_one_line()
</div>
<div class="viewcode-block" id="JrrleFileWrapper.inquire"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_jrrle.JrrleFileWrapper.inquire">[docs]</a>    def inquire(self, fld_name):
        try:
            meta = self.fields_seen[fld_name]
            self.seek(meta['file_position'])
            return meta
        except KeyError:
            last_added = next(reversed(self.fields_seen))
            self.seek(self.fields_seen[last_added]['file_position'])
            self.advance_one_line()

            while not self.seen_all_fields:
                found_fld_name, meta = self.inquire_next()
                if found_fld_name == fld_name:
                    return meta
                self.advance_one_line()

            raise KeyError("file '{0}' has no field '{1}'".format(
                           self.filename, fld_name))
</div>
<div class="viewcode-block" id="JrrleFileWrapper.inquire_next"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_jrrle.JrrleFileWrapper.inquire_next">[docs]</a>    def inquire_next(self):
        """Collect the meta-data from the next field in the file

        Returns:
            tuple (field name, dict of meta data) both
            of which will be None if there are no more Fields

        Note:
            After this operation is done, the file-pointer will be reset
            to the position it was before the inquiry.
        """
        if not self.isopen:
            raise RuntimeError("file is not open")

        varname = np.array(" "*80)
        tstring = np.array(" "*80)
        found_field, ndim, nx, ny, nz, it = _jrrle.inquire_next(self._unit,
                                                                varname,
                                                                tstring)
        if not found_field:
            self.seen_all_fields = True
            return None, None

        vname = (str(varname)).strip()

        if vname in self.fields_seen:
            meta = self.fields_seen[vname]
        else:
            dims = tuple(x for x in (nx, ny, nz) if x &gt; 0)

            meta = dict(timestr=tstring,
                        inttime=it,
                        ndim=ndim,
                        dims=dims,
                        file_position=self.tell())
            self.fields_seen[vname] = meta

        return vname, meta

</div></div>
<div class="viewcode-block" id="JrrleDataWrapper"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_jrrle.JrrleDataWrapper">[docs]</a>class JrrleDataWrapper(vfile.DataWrapper):
    """  """
    file_wrapper = None
    filename = None
    fld_name = None
    expected_shape = None

    def __init__(self, file_wrapper, fld_name, expected_shape):
        """Lazy wrapper for a field in a jrrle file

        Parameters:
            expected_shape (tuple): shape of data in the file (xyz)
        """
        super(JrrleDataWrapper, self).__init__()
        self.file_wrapper = file_wrapper
        self.filename = file_wrapper.filename
        self.fld_name = fld_name
        # translate to zyx
        self.expected_shape = expected_shape

    @property
<div class="viewcode-block" id="JrrleDataWrapper.shape"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_jrrle.JrrleDataWrapper.shape">[docs]</a>    def shape(self):
        """
        Returns:
            zyx shape since that's the shape __array__ returns
        """
        return self.expected_shape[::-1]
</div>
    @property
<div class="viewcode-block" id="JrrleDataWrapper.dtype"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_jrrle.JrrleDataWrapper.dtype">[docs]</a>    def dtype(self):
        return np.dtype("float32")
</div>
    def __array__(self, *args, **kwargs):
        with self.file_wrapper as f:
            ndim = len(self.expected_shape)
            # fld_name, meta, arr = f.read_field_at(self.loc, ndim)
            meta, arr = f.read_field(self.fld_name, ndim)
            arr = np.array(arr.flatten(order='F').reshape(meta['dims'][::-1]),
                           order='C')

        # meta's dims are xyz (from file), but ex
        if meta['dims'] != self.expected_shape:
            raise RuntimeError("Field '{0}' from file '{1}' has shape {2} "
                               "instead of {3}".format(self.fld_name,
                               self.filename, meta['dims'],
                               self.expected_shape))
        return arr.astype(self.dtype)

<div class="viewcode-block" id="JrrleDataWrapper.read_direct"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_jrrle.JrrleDataWrapper.read_direct">[docs]</a>    def read_direct(self, *args, **kwargs):
        return self.__array__()
</div>
<div class="viewcode-block" id="JrrleDataWrapper.len"><a class="viewcode-back" href="../../../viscid.readers.html#viscid.readers.ggcm_jrrle.JrrleDataWrapper.len">[docs]</a>    def len(self):
        return self.shape[0]
</div>
    def __getitem__(self, item):
        return self.__array__().__getitem__(item)


# class JrrleIonoDataWrapper(JrrleDataWrapper):
#     @property
#     def shape(self):
#         ret = tuple([n - 1 for n in reversed(self.expected_shape)])
#         return ret

#     def __array__(self, *args, **kwargs):
#         arr = super(JrrleIonoDataWrapper, self).__array__(*args, **kwargs)
#         ndim = len(self.expected_shape)
#         return arr[[slice(None, -1)]*ndim]

##
## EOF
##</div>
</pre>

          <footer>
  <hr/>

  <p>
      &copy; Copyright 2013, Kristofor Maynard.
  </p>

  <a href="https://www.github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="http://www.readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  

</body>
</html>
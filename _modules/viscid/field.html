

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>viscid.field &mdash; Viscid 0.70.2 documentation</title>
  

  
  

  
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700' rel='stylesheet' type='text/css'>

  
  

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'../../',
        VERSION:'0.70.2',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
      };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
    <link rel="top" title="Viscid 0.70.2 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../index.html" class="icon icon-home"> Viscid</a>
        <form class="wy-form" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search docs" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#standard-setup">Standard Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#for-developers">For Developers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../philosophy.html">Philosophy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../philosophy.html#data-abstraction">Data Abstraction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../custom_behavior.html">Custom Behavior (rc file)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../custom_behavior.html#common-customizations">Common Customizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../custom_behavior.html#viscid-grid-grid">viscid.grid.Grid</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../custom_behavior.html#viscid-readers-openggcm-ggcmgrid">viscid.readers.openggcm.GGCMGrid</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../custom_behavior.html#viscid-readers-openggcm-ggcmfile">viscid.readers.openggcm.GGCMFile</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_reader.html">Reading/Plotting Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../ex_reader.html#super-simple">Super Simple</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ex_reader.html#two-plots-one-figure">Two Plots, One Figure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ex_reader.html#playing-with-time">Playing with Time</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_slicing.html">Slicing Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../ex_slicing.html#spatial-slices">Spatial Slices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ex_slicing.html#temporal-slices">Temporal Slices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_openggcm.html">OpenGGCM Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../ex_openggcm.html#gse-coordinates">GSE coordinates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ex_openggcm.html#time-series">Time Series</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ex_openggcm.html#ionosphere-files">Ionosphere Files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_calc.html">Calculator Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../ex_calc.html#streamlines">Streamlines</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../command_line.html">Command Line Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../command_line.html#viscid-2d">viscid_2d</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../command_line.html#viscid-ts">viscid_ts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../command_line.html#viscid-diff">viscid_diff</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../command_line.html#athena2xdmf">athena2xdmf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../command_line.html#bitmaskbits">bitmaskbits</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../viscid.html">viscid package</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="/">Viscid</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <ul class="wy-breadcrumbs">
  <li><a href="../../index.html">Docs</a> &raquo;</li>
  <li><a href="">viscid.field</a></li>
  
</ul>
<hr/>

          
  <h1>Source code for viscid.field</h1><div class="highlight"><pre>
<span class="c"># pylint: disable=too-many-lines</span>
<span class="sd">&quot;&quot;&quot;Fields are the basis of Viscid&#39;s data abstration</span>

<span class="sd">Fields belong in grids, or by themselves as a result of a calculation.</span>
<span class="sd">They can belong to a :class:`Grid` as the result of a file load, or</span>
<span class="sd">by themselves as the result of a calculation. This module has some</span>
<span class="sd">convenience functions for creating fields similar to `Numpy`.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span><span class="p">,</span> <span class="n">islice</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">isclass</span>
<span class="kn">import</span> <span class="nn">types</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">viscid</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">viscid.compat</span> <span class="kn">import</span> <span class="n">string_types</span><span class="p">,</span> <span class="n">izip_longest</span>
<span class="kn">from</span> <span class="nn">viscid</span> <span class="kn">import</span> <span class="n">coordinate</span>
<span class="kn">from</span> <span class="nn">viscid</span> <span class="kn">import</span> <span class="n">vutil</span>
<span class="kn">from</span> <span class="nn">viscid</span> <span class="kn">import</span> <span class="n">tree</span>

<span class="n">LAYOUT_DEFAULT</span> <span class="o">=</span> <span class="s">&quot;none&quot;</span>  <span class="c"># do not translate</span>
<span class="n">LAYOUT_INTERLACED</span> <span class="o">=</span> <span class="s">&quot;interlaced&quot;</span>
<span class="n">LAYOUT_FLAT</span> <span class="o">=</span> <span class="s">&quot;flat&quot;</span>
<span class="n">LAYOUT_SCALAR</span> <span class="o">=</span> <span class="s">&quot;scalar&quot;</span>
<span class="n">LAYOUT_OTHER</span> <span class="o">=</span> <span class="s">&quot;other&quot;</span>

<div class="viewcode-block" id="empty"><a class="viewcode-back" href="../../viscid.html#viscid.field.empty">[docs]</a><span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">crds</span><span class="p">,</span> <span class="n">nr_comps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">LAYOUT_FLAT</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="s">&quot;Cell&quot;</span><span class="p">,</span>
          <span class="n">dtype</span><span class="o">=</span><span class="s">&quot;float64&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analogous to `numpy.empty` (uninitialized array)</span>

<span class="sd">    Parameters:</span>
<span class="sd">        typ (str): &#39;Scaler&#39; / &#39;Vector&#39;</span>
<span class="sd">        name (str): a way to refer to the field programatically</span>
<span class="sd">        crds (Coordinates): coordinates that describe the shape / grid</span>
<span class="sd">            of the field</span>
<span class="sd">        nr_comps (int, optional): for vector fields, nr of components</span>
<span class="sd">        layout (str, optional): how data is stored, is in &quot;flat&quot; or</span>
<span class="sd">            &quot;interlaced&quot; (interlaced == AOS)</span>
<span class="sd">        center (str, optional): cell or node, there really isn&#39;t</span>
<span class="sd">            support for edge / face yet</span>
<span class="sd">        dtype (optional): some way to describe numpy dtype of data</span>
<span class="sd">        kwargs: passed through to Field constructor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">center</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;cell&quot;</span><span class="p">:</span>
        <span class="n">sshape</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">shape_cc</span>
    <span class="k">elif</span> <span class="n">center</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;node&quot;</span><span class="p">:</span>
        <span class="n">sshape</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">shape_nc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sshape</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">shape_nc</span>

    <span class="k">if</span> <span class="n">ScalarField</span><span class="o">.</span><span class="n">istype</span><span class="p">(</span><span class="n">typ</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">sshape</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">layout</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">LAYOUT_INTERLACED</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">sshape</span> <span class="o">+</span> <span class="p">[</span><span class="n">nr_comps</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">nr_comps</span><span class="p">]</span> <span class="o">+</span> <span class="n">sshape</span>

    <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrap_field</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">crds</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="empty_like"><a class="viewcode-back" href="../../viscid.html#viscid.field.empty_like">[docs]</a><span class="k">def</span> <span class="nf">empty_like</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fld</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analogous to `numpy.empty_like`</span>

<span class="sd">    Makes a new, unitilialized :class:`Field`. Copies as much meta data</span>
<span class="sd">    as it can from `fld`.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        name: name for this field</span>
<span class="sd">        fld: field to get coordinates / metadata from</span>
<span class="sd">        kwargs: passed through to :class:`Field` constructor</span>

<span class="sd">    Returns:</span>
<span class="sd">        new uninitialized :class:`Field`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fld</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">center</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">time</span>
    <span class="k">return</span> <span class="n">wrap_field</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">crds</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                      <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">fld</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="zeros_like"><a class="viewcode-back" href="../../viscid.html#viscid.field.zeros_like">[docs]</a><span class="k">def</span> <span class="nf">zeros_like</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fld</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analogous to `numpy.zeros_like`</span>

<span class="sd">    Returns:</span>
<span class="sd">        new :class:`Field` initialized to 0</span>

<span class="sd">    See Also: :meth:`empty_like`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fld</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">center</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">time</span>
    <span class="k">return</span> <span class="n">wrap_field</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">crds</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                      <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">fld</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ones_like"><a class="viewcode-back" href="../../viscid.html#viscid.field.ones_like">[docs]</a><span class="k">def</span> <span class="nf">ones_like</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fld</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analogous to `numpy.ones_like`</span>

<span class="sd">    Returns:</span>
<span class="sd">        new :class:`Field` initialized to 1</span>

<span class="sd">    See Also: :meth:`empty_like`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fld</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">center</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">time</span>
    <span class="k">return</span> <span class="n">wrap_field</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">crds</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                      <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">fld</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="scalar_fields_to_vector"><a class="viewcode-back" href="../../viscid.html#viscid.field.scalar_fields_to_vector">[docs]</a><span class="k">def</span> <span class="nf">scalar_fields_to_vector</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fldlist</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert scaler fields to a vector field</span>

<span class="sd">    Parameters:</span>
<span class="sd">        name (str): name for the vector field</span>
<span class="sd">        fldlist: list of :class:`ScalarField`</span>
<span class="sd">        kwargs: passed to :class:`VectorField` constructor</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new :class:`VectorField`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">fldlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">fldlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">center</span>
    <span class="n">crds</span> <span class="o">=</span> <span class="n">fldlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_src_crds</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">fldlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
    <span class="c"># shape = fldlist[0].data.shape</span>

    <span class="n">_crds</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">crds</span><span class="p">)(</span><span class="n">crds</span><span class="o">.</span><span class="n">get_clist</span><span class="p">())</span>

    <span class="n">vfield</span> <span class="o">=</span> <span class="n">VectorField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_crds</span><span class="p">,</span> <span class="n">fldlist</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                         <span class="n">meta</span><span class="o">=</span><span class="n">fldlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">fldlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vfield</span>
</div>
<div class="viewcode-block" id="field_type"><a class="viewcode-back" href="../../viscid.html#viscid.field.field_type">[docs]</a><span class="k">def</span> <span class="nf">field_type</span><span class="p">(</span><span class="n">typ</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lookup a Field type</span>

<span class="sd">    The magic lookup happens when typ is a string, if typ is a class</span>
<span class="sd">    then just return the class for convenience.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        typ: python class object or string describing a field type in</span>
<span class="sd">            some way</span>

<span class="sd">    Returns:</span>
<span class="sd">        a :class:`Field` subclass</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">isclass</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">typ</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">vutil</span><span class="o">.</span><span class="n">subclass_spider</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">istype</span><span class="p">(</span><span class="n">typ</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cls</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Field type {0} not understood&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typ</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="wrap_field"><a class="viewcode-back" href="../../viscid.html#viscid.field.wrap_field">[docs]</a><span class="k">def</span> <span class="nf">wrap_field</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">crds</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convenience script for wrapping ndarrays</span>

<span class="sd">    Parameters:</span>
<span class="sd">        typ (str): &#39;Scaler&#39; / &#39;Vector&#39;</span>
<span class="sd">        name (str): a way to refer to the field programatically</span>
<span class="sd">        crds (Coordinates): coordinates that describe the shape / grid</span>
<span class="sd">            of the field</span>
<span class="sd">        data: Some data container, most likely a ``numpy.ndarray``</span>
<span class="sd">        kwargs: passed through to :class:`Field` constructor</span>

<span class="sd">    Returns:</span>
<span class="sd">        A :class:`Field` instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#</span>
    <span class="c">#len(clist), clist[0][0], len(clist[0][1]), type)</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="n">field_type</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">crds</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;can not decipher field&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="rewrap_field"><a class="viewcode-back" href="../../viscid.html#viscid.field.rewrap_field">[docs]</a><span class="k">def</span> <span class="nf">rewrap_field</span><span class="p">(</span><span class="n">fld</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">fld</span><span class="p">)(</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">crds</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">fld</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
                    <span class="n">forget_source</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">_copy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">fld</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ret</span>
</div>
<div class="viewcode-block" id="Field"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field">[docs]</a><span class="k">class</span> <span class="nc">Field</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Leaf</span><span class="p">):</span>
    <span class="n">_TYPE</span> <span class="o">=</span> <span class="s">&quot;none&quot;</span>
    <span class="n">_CENTERING</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;node&#39;</span><span class="p">,</span> <span class="s">&#39;cell&#39;</span><span class="p">,</span> <span class="s">&#39;grid&#39;</span><span class="p">,</span> <span class="s">&#39;face&#39;</span><span class="p">,</span> <span class="s">&#39;edge&#39;</span><span class="p">]</span>
    <span class="n">_COMPONENT_NAMES</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

    <span class="c"># set on __init__</span>
    <span class="c"># NOTE: _src_data is allowed by be a list to support creating vectors from</span>
    <span class="c"># some scalar fields without necessarilly loading the data</span>
    <span class="n">_center</span> <span class="o">=</span> <span class="s">&quot;none&quot;</span>  <span class="c"># String in CENTERING</span>
    <span class="n">_src_data</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># numpy-like object (h5py too), or list of these objects</span>

    <span class="n">_src_crds</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># Coordinate object</span>
    <span class="n">_crds</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># Coordinate object</span>

    <span class="c"># dict, this stuff will be copied by self.wrap</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c">#</span>
    <span class="c"># dict, used for stuff that won&#39;t be blindly copied by self.wrap</span>
    <span class="n">deep_meta</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">pretty_name</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># String</span>

    <span class="n">post_reshape_transform_func</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">transform_func_kwargs</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># _parent_field is a hacky way to keep a &#39;parent&#39; field in sync when data</span>
    <span class="c"># is loaded... this is used for converting cell centered data -&gt;</span>
    <span class="c"># node centered and back... this only works because _fill_cache</span>
    <span class="c"># ONLY sets self._cache... if other meta data were set by</span>
    <span class="c"># _fill_cache, that would need to propogate upstream too</span>
    <span class="n">_parent_field</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># these get reset when data is set</span>
    <span class="n">_layout</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_nr_comps</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_nr_comp</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_dtype</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># set when data is retrieved</span>
    <span class="n">_cache</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># this will always be a numpy array</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">crds</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="s">&quot;Node&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">deep_meta</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">forget_source</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pretty_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">post_reshape_transform_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">info</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">_parent_field</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            parents: Dataset, Grid, Field, or list of any of</span>
<span class="sd">                those. These parents are the sources for find_info, and</span>
<span class="sd">                and monkey-pached methods.</span>
<span class="sd">            _parent_field (Field): special parent where data can be taken</span>
<span class="sd">                for lazy loading. This field is added to parents</span>
<span class="sd">                automatically</span>

<span class="sd">        Other Parameters:</span>
<span class="sd">            kwargs with a leading underscore (like _copy) are added to</span>
<span class="sd">            the deep_meta dict without the leading _. Everything else</span>
<span class="sd">            is added to the meta dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Field</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">parents</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span> <span class="o">=</span> <span class="n">crds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="n">pretty_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pretty_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pretty_name</span> <span class="o">=</span> <span class="n">pretty_name</span>

        <span class="c"># # i think this is a mistake</span>
        <span class="c"># if isinstance(data, (list, tuple)) and isinstance(data[0], Field):</span>
        <span class="c">#     if post_reshape_transform_func is None:</span>
        <span class="c">#         post_reshape_transform_func = data[0].post_reshape_transform_func</span>
        <span class="c">#     if transform_func_kwargs is None:</span>
        <span class="c">#         transform_func_kwargs = data[0].transform_func_kwargs</span>

        <span class="k">if</span> <span class="n">post_reshape_transform_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_reshape_transform_func</span> <span class="o">=</span> <span class="n">post_reshape_transform_func</span>
        <span class="k">if</span> <span class="n">transform_func_kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform_func_kwargs</span> <span class="o">=</span> <span class="n">transform_func_kwargs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform_func_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">meta</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">deep_meta</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">deep_meta</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s">&quot;force_layout&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;force_layout&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;deprecated force_layout syntax: kwarg should &quot;</span>
                              <span class="s">&quot;be given as _force_layout&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;force_layout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s">&quot;force_layout&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;force_layout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LAYOUT_DEFAULT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;force_layout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;force_layout&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s">&quot;copy&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;copy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_field</span> <span class="o">=</span> <span class="n">_parent_field</span>
        <span class="k">if</span> <span class="n">_parent_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_parent_field</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">forget_source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forget_source</span><span class="p">()</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Field.type"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.type">[docs]</a>    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TYPE</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center</span>
    <span class="nd">@center.setter</span>
<div class="viewcode-block" id="Field.center"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.center">[docs]</a>    <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_center</span><span class="p">):</span>
        <span class="n">new_center</span> <span class="o">=</span> <span class="n">new_center</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">new_center</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CENTERING</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_center</span> <span class="o">=</span> <span class="n">new_center</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">layout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get the layout type, &#39;interlaced&#39; (AOS) | &#39;flat (SOA)&#39;. This at most</span>
<span class="sd">        calls _detect_layout(_src_data) which tries to be lazy &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;force_layout&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">LAYOUT_DEFAULT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;force_layout&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_layout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span>

    <span class="nd">@layout.setter</span>
<div class="viewcode-block" id="Field.layout"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.layout">[docs]</a>    <span class="k">def</span> <span class="nf">layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_layout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; UNTESTED, unload data if layout changes &quot;&quot;&quot;</span>
        <span class="n">new_layout</span> <span class="o">=</span> <span class="n">new_layout</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_loaded</span><span class="p">():</span>
            <span class="n">current_layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span>
            <span class="k">if</span> <span class="n">new_layout</span> <span class="o">!=</span> <span class="n">current_layout</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;force_layout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span> <span class="o">=</span> <span class="bp">None</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Field.nr_dims"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.nr_dims">[docs]</a>    <span class="k">def</span> <span class="nf">nr_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns number of dims, this should be the number of dims of</span>
<span class="sd">        the underlying data, but is assumed a priori so no data load is</span>
<span class="sd">        done here &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_sdims</span> <span class="o">+</span> <span class="mi">1</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Field.nr_sdims"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.nr_sdims">[docs]</a>    <span class="k">def</span> <span class="nf">nr_sdims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; number of spatial dims, same as crds.nr_dims, does not</span>
<span class="sd">        explicitly load the data &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">nr_dims</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Field.nr_comps"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.nr_comps">[docs]</a>    <span class="k">def</span> <span class="nf">nr_comps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; how many components are there? Only inspects _src_data &quot;&quot;&quot;</span>
        <span class="c"># this gets # of comps from src_data, so layout is given as layout</span>
        <span class="c"># of src_data since it might not be loaded yet</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nr_comps</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_layout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_INTERLACED</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="c"># this is an awkward way to get the data in here...</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_nr_comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_nr_comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_FLAT</span><span class="p">:</span>
                <span class="c"># length of 1st dim... this works for ndarrays &amp;&amp; lists</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nr_comps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_SCALAR</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nr_comps</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Could not detect data layout; &quot;</span>
                                   <span class="s">&quot;can&#39;t give nr_comps&quot;</span><span class="p">)</span>
                <span class="c"># return self._src_data.shape[-1]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nr_comps</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Field.nr_comp"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.nr_comp">[docs]</a>    <span class="k">def</span> <span class="nf">nr_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; dimension of the components of the vector, loads the data if</span>
<span class="sd">        self.layout does &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nr_comp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span>
            <span class="k">if</span> <span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_FLAT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nr_comp</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_INTERLACED</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nr_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">nr_dims</span>
            <span class="k">elif</span> <span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_SCALAR</span><span class="p">:</span>
                <span class="c"># use same as interlaced for slicing convenience, note</span>
                <span class="c"># this is only for a one component vector, for scalars</span>
                <span class="c"># nr_comp is None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nr_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">nr_dims</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Could not detect data layout; &quot;</span>
                                   <span class="s">&quot;can&#39;t give nr_comp&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nr_comp</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Field.shape"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.shape">[docs]</a>    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns the shape of the underlying data, does not explicitly load</span>
<span class="sd">        the data &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sshape</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_comp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_comps</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">s</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Field.sshape"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.sshape">[docs]</a>    <span class="k">def</span> <span class="nf">sshape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; shape of spatial dimensions, does not include comps, and is not</span>
<span class="sd">        the same shape as underlying array, does not load the data &quot;&quot;&quot;</span>
        <span class="c"># it is enforced that the cached data has a shape that agrees with</span>
        <span class="c"># the coords by _reshape_ndarray_to_crds... actually, that method</span>
        <span class="c"># requires this method to depend on the crd shape</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscentered</span><span class="p">(</span><span class="s">&quot;node&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">shape_nc</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscentered</span><span class="p">(</span><span class="s">&quot;cell&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">shape_cc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;edge/face vectors not implemented, assuming &quot;</span>
                        <span class="s">&quot;node shape&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">shape</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Field.size"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.size">[docs]</a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; how many values are in underlying data &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Field.ssize"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.ssize">[docs]</a>    <span class="k">def</span> <span class="nf">ssize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; how many values make up one component of the underlying data &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sshape</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Field.dtype"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.dtype">[docs]</a>    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># print(type(self._src_data))</span>
        <span class="c"># dtype.name is for pruning endianness out of dtype</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="o">.</span><span class="n">dtype</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">crds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crds</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_crds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">apply_reflections</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crds</span>

    <span class="nd">@crds.setter</span>
<div class="viewcode-block" id="Field.crds"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.crds">[docs]</a>    <span class="k">def</span> <span class="nf">crds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_crds</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span> <span class="o">=</span> <span class="n">val</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; if you want to fill the cache, this will do it, note that</span>
<span class="sd">        to empty the cache later you can always use unload &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fill_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
    <span class="nd">@data.setter</span>
<div class="viewcode-block" id="Field.data"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.data">[docs]</a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
        <span class="c"># clean up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_purge_cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nr_comp</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nr_comps</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span> <span class="o">=</span> <span class="n">dat</span>
        <span class="c"># self._translate_src_data()  # um, what&#39;s this for? looks dangerous</span>
        <span class="c"># do some sort of lazy pre-setup _src_data inspection?</span>
</div>
<div class="viewcode-block" id="Field.is_loaded"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.is_loaded">[docs]</a>    <span class="k">def</span> <span class="nf">is_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</div>
    <span class="k">def</span> <span class="nf">_purge_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; does not guarentee that the memory will be freed &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_field</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
    <span class="k">def</span> <span class="nf">_fill_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; actually load data into the cache &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data_to_ndarray</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_field</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>

    <span class="c"># um, what was this for? looks dangerous</span>
    <span class="c"># def _translate_src_data(self):</span>
    <span class="c">#     pass</span>

    <span class="k">def</span> <span class="nf">_src_data_to_ndarray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; prep the src data into something usable and enforce a layout &quot;&quot;&quot;</span>
        <span class="c"># some magic may need to happen here to accept more than np/h5 data</span>
        <span class="c"># override if a type does something fancy (eg, interlacing)</span>
        <span class="c"># and dat.flags[&quot;OWNDATA&quot;]  # might i want this?</span>
        <span class="n">src_data_layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_layout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">)</span>
        <span class="n">force_layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;force_layout&quot;</span><span class="p">]</span>

        <span class="c"># we will preserve layout or we already have the correct layout,</span>
        <span class="c"># do no translation</span>
        <span class="k">if</span> <span class="n">force_layout</span> <span class="o">==</span> <span class="n">LAYOUT_DEFAULT</span> <span class="ow">or</span> \
           <span class="n">force_layout</span> <span class="o">==</span> <span class="n">src_data_layout</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dat_to_ndarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">)</span>

        <span class="c"># if layout is found to be other, i cant do anything with that</span>
        <span class="k">elif</span> <span class="n">src_data_layout</span> <span class="o">==</span> <span class="n">LAYOUT_OTHER</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Cannot auto-detect layout; not translating; &quot;</span>
                        <span class="s">&quot;performance may suffer&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dat_to_ndarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">)</span>

        <span class="c"># ok, we demand FLAT arrays, make it so</span>
        <span class="k">elif</span> <span class="n">force_layout</span> <span class="o">==</span> <span class="n">LAYOUT_FLAT</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">src_data_layout</span> <span class="o">!=</span> <span class="n">LAYOUT_INTERLACED</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;I should not be here&quot;</span><span class="p">)</span>

            <span class="n">nr_comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_comps</span>
            <span class="n">data_dest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_comps</span><span class="p">):</span>
                <span class="c"># NOTE: I wonder if this is the fastest way to reorder</span>
                <span class="n">data_dest</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                <span class="c"># NOTE: no special case for lists, they are not</span>
                <span class="c"># interpreted this way</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dat_to_ndarray</span><span class="p">(</span><span class="n">data_dest</span><span class="p">)</span>

        <span class="c"># ok, we demand INTERLACED arrays, make it so</span>
        <span class="k">elif</span> <span class="n">force_layout</span> <span class="o">==</span> <span class="n">LAYOUT_INTERLACED</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">src_data_layout</span> <span class="o">!=</span> <span class="n">LAYOUT_FLAT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;I should not be here&quot;</span><span class="p">)</span>

            <span class="n">nr_comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_comps</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">data_dest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_comps</span><span class="p">):</span>
                <span class="n">data_dest</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span> <span class="o">=</span> <span class="n">LAYOUT_INTERLACED</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dat_to_ndarray</span><span class="p">(</span><span class="n">data_dest</span><span class="p">)</span>

        <span class="c"># catch the remaining cases</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;force_layout&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LAYOUT_OTHER</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;How should I know how to force other layout?&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Bad argument for layout forcing&quot;</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;I should not be here&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_dat_to_ndarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This should be the last thing called for all data that gets put</span>
<span class="sd">        into the cache. It makes dimensions jive correctly. This will translate</span>
<span class="sd">        non-ndarray data structures to a flat ndarray. Also, this function</span>
<span class="sd">        makes damn sure that the dimensionality of the coords matches the</span>
<span class="sd">        dimensionality of the array, which is to say, if the array is only 2d,</span>
<span class="sd">        but the coords have a 3rd dimension with length 1, reshape the array</span>
<span class="sd">        to include that extra dimension.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># dtype.name is for pruning endianness out of dtype</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;copy&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;copy&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">]</span>
            <span class="n">_shape</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">_shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
                <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="c"># elif isinstance(dat, Field):</span>
        <span class="c">#     arr = dat.data  # not the way</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;copy&quot;</span><span class="p">])</span>

        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reshape_ndarray_to_crds</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nr_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_comp</span>
            <span class="n">nr_comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_comps</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">nr_comp</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">nr_comps</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># FIXME, there should be a flag for whether or not this should</span>
        <span class="c"># make a copy of the array if it&#39;s not contiguous in memory</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">reflect_fld_arr</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscentered</span><span class="p">(</span><span class="s">&quot;Cell&quot;</span><span class="p">),</span>
                                        <span class="n">nr_comp</span><span class="p">,</span> <span class="n">nr_comps</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_reshape_transform_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_reshape_transform_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_func_kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">arr</span>

    <span class="k">def</span> <span class="nf">_reshape_ndarray_to_crds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; enforce same dimensionality as coords here!</span>
<span class="sd">        self.shape better still be using the crds shape corrected for</span>
<span class="sd">        node / cell centering</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">arr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_detect_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns LAYOUT_XXX, this just looks at len(dat) or dat.shape &quot;&quot;&quot;</span>
        <span class="c"># if i receive a list, then i suppose i have a list of</span>
        <span class="c"># arrays, one for each component... this is a flat layout</span>
        <span class="n">sshape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sshape</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="c"># Make sure the list makes sense... this strictly speaking</span>
            <span class="c"># doesn&#39;t need to happen, but it&#39;s a bad habbit to allow</span>
            <span class="c"># shapes through that I don&#39;t explicitly plan for, since</span>
            <span class="c"># this is just the door to the rabbit hole</span>
            <span class="c"># BUT, this has the side effect that one can&#39;t create vector</span>
            <span class="c"># fields with vx = Xcc, one has to use</span>
            <span class="c"># vx = Xcc + 0 * Ycc + 0 * Zcc, which is rather cumbersome</span>
            <span class="c"># for d in dat:</span>
            <span class="c">#     assert(list(d.shape) == list(sshape))</span>
            <span class="k">return</span> <span class="n">LAYOUT_FLAT</span>

        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="n">sshape</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">LAYOUT_SCALAR</span>

        <span class="c"># if the crds shape has more values than the dat.shape</span>
        <span class="c"># then try trimming the directions that have 1 element</span>
        <span class="c"># this can happen when crds are 3d, but field is only 2d</span>
        <span class="c">## I&#39;m not sure why this needs to happen... but tests fail</span>
        <span class="c">## without it</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">sshape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sshape</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c"># check which dims match the shape of the crds</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="n">sshape</span><span class="p">:</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_SCALAR</span>
        <span class="k">elif</span> <span class="nb">list</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">==</span> <span class="n">sshape</span><span class="p">:</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_FLAT</span>
        <span class="k">elif</span> <span class="nb">list</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">sshape</span><span class="p">:</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_INTERLACED</span>
        <span class="k">elif</span> <span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">sshape</span><span class="p">):</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_INTERLACED</span>
        <span class="k">elif</span> <span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">sshape</span><span class="p">):</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_FLAT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># if this happens, don&#39;t ignore it even if it happens to work</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;could not detect layout for &#39;{0}&#39;: shape = {1} &quot;</span>
                        <span class="s">&quot;target shape = {2}&quot;</span>
                        <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sshape</span><span class="p">))</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_OTHER</span>

        <span class="k">return</span> <span class="n">layout</span>

    <span class="k">def</span> <span class="nf">_prepare_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; if selection has a slice for component dimension, set it aside &quot;&quot;&quot;</span>
        <span class="n">comp_slc</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># try to look for a vector component slice</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_comps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">sel_lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
                    <span class="n">_isstr</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="p">)</span>
                    <span class="n">sel_lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">_</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)]</span>  <span class="c"># pylint: disable=maybe-no-member</span>
                    <span class="n">_isstr</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sel_lst</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_COMPONENT_NAMES</span><span class="p">:</span>
                            <span class="c"># ok, this is asking for a component</span>
                            <span class="n">comp_slc</span> <span class="o">=</span> <span class="n">s</span>
                            <span class="n">sel_lst</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_lst</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_dims</span> <span class="ow">and</span> <span class="n">comp_slc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">comp_slc</span> <span class="o">=</span> <span class="n">sel_lst</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_comp</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp_slc</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                    <span class="n">comp_slc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_COMPONENT_NAMES</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">comp_slc</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_isstr</span><span class="p">:</span>
                    <span class="n">selection</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sel_lst</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">selection</span> <span class="o">=</span> <span class="n">sel_lst</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">comp_slc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">comp_slc</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">selection</span><span class="p">,</span> <span class="n">comp_slc</span>

    <span class="k">def</span> <span class="nf">_finalize_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">crdlst</span><span class="p">,</span> <span class="n">reduced</span><span class="p">,</span> <span class="n">comp_slc</span><span class="p">):</span>
        <span class="n">all_none</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">))</span>
        <span class="n">no_sslices</span> <span class="o">=</span> <span class="n">slices</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">all_none</span>
        <span class="n">no_compslice</span> <span class="o">=</span> <span class="n">comp_slc</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">comp_slc</span> <span class="o">==</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

        <span class="c"># no slice necessary, just pass the field through</span>
        <span class="k">if</span> <span class="n">no_sslices</span> <span class="ow">and</span> <span class="n">no_compslice</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c"># if we&#39;re doing a component slice, and the underlying</span>
        <span class="c"># data is a list/tuple of Field objects, we don&#39;t need</span>
        <span class="c"># to do any more work</span>
        <span class="n">src_is_fld_list</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span>
                           <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">no_sslices</span> <span class="ow">and</span> <span class="n">src_is_fld_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_reshape_transform_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">[</span><span class="n">comp_slc</span><span class="p">]</span>

        <span class="c"># coord transforms are not copied on purpose</span>
        <span class="n">crds</span> <span class="o">=</span> <span class="n">coordinate</span><span class="o">.</span><span class="n">wrap_crds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">crdlst</span><span class="p">)</span>

        <span class="c"># be intelligent here, if we haven&#39;t loaded the data and</span>
        <span class="c"># the source is an h5py-like source, we don&#39;t have to read</span>
        <span class="c"># the whole field; h5py will deal with the hyperslicing for us</span>
        <span class="n">slced_dat</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">hypersliceable</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">,</span> <span class="s">&quot;_hypersliceable&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">single_comp_slc</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp_slc</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscentered</span><span class="p">(</span><span class="s">&quot;Cell&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">src_is_fld_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">single_comp_slc</span><span class="p">:</span>
                <span class="c"># this may not work as advertised since slices may</span>
                <span class="c"># not be complete?</span>
                <span class="n">slced_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">[</span><span class="n">comp_slc</span><span class="p">][</span><span class="n">slices</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">[</span><span class="n">comp_slc</span><span class="p">]</span>
                <span class="n">slced_dat</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="n">slices</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">hypersliceable</span><span class="p">:</span>
            <span class="c"># we have to flip the slice, meaning: if the array looks like</span>
            <span class="c"># ind     : 0    1     2    3    4    5    6</span>
            <span class="c"># x       : -1.0 -0.5  0.0  0.5  1.0  1.5  2.0</span>
            <span class="c"># -x[::-1]: -2.0 -1.5 -1.0 -0.5  0.0  0.5  1.0</span>
            <span class="c"># if the slice is [-0.5:1.0], the crds figured out the slice</span>
            <span class="c"># indices after doing -x[::-1], so the slice will be [3:7],</span>
            <span class="c"># but in _src_dat, that data lives at indices [0:3]</span>
            <span class="c"># so what we want is _src_data[::-1][3:6], but a more efficient</span>
            <span class="c"># way to do this for large data sets is _src_data[0:3][::-1]</span>
            <span class="c"># We will always read _src_data forward, then flip it since</span>
            <span class="c"># h5py won&#39;t do a slice of [3:0:-1]</span>
            <span class="n">first_slc</span><span class="p">,</span> <span class="n">second_slc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">reflect_slices</span><span class="p">(</span><span class="n">slices</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

            <span class="c"># now put component slice back in</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nr_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_comp</span>
                <span class="n">first_slc</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_comp</span><span class="p">,</span> <span class="n">comp_slc</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">single_comp_slc</span><span class="p">:</span>
                    <span class="n">second_slc</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_comp</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">nr_comp</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c"># this is a bad hack for the fact that fields and the slices</span>
            <span class="c"># have 3 spatial dimensions, but the src_data may have fewer</span>
            <span class="n">_first</span><span class="p">,</span> <span class="n">_second</span> <span class="o">=</span> <span class="n">first_slc</span><span class="p">,</span> <span class="n">second_slc</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_first</span><span class="p">):</span>
                <span class="n">_first</span><span class="p">,</span> <span class="n">_second</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># trailing index</span>
                <span class="n">it</span> <span class="o">=</span> <span class="n">izip_longest</span><span class="p">(</span><span class="n">count</span><span class="p">(),</span> <span class="n">first_slc</span><span class="p">,</span> <span class="n">second_slc</span><span class="p">,</span>
                                  <span class="n">fillvalue</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_slc</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">_first</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="n">_second</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c"># ok, now cull out from the second slice</span>
            <span class="n">_second</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">_second</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>

            <span class="c"># only hyperslice _src_data if our slice has the right shape</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">_first</span><span class="p">):</span>
                <span class="c"># do the hyper-slice</span>
                <span class="n">slced_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_first</span><span class="p">)][</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_second</span><span class="p">)]</span>

                <span class="c"># post-reshape-transform</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_reshape_transform_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cc</span><span class="p">:</span>
                        <span class="n">target_shape</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">shape_cc</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">target_shape</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">shape_nc</span>
                    <span class="k">if</span> <span class="n">nr_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">target_shape</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">nr_comp</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">slced_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_reshape_transform_func</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">crds</span><span class="p">,</span> <span class="n">slced_dat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">target_shape</span><span class="p">),</span>
                        <span class="n">comp_slc</span><span class="o">=</span><span class="n">comp_slc</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_func_kwargs</span><span class="p">)</span>

        <span class="c"># fallback: either not hypersliceable, or the shapes didn&#39;t match up</span>
        <span class="k">if</span> <span class="n">slced_dat</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">slices</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_comp</span><span class="p">,</span> <span class="n">comp_slc</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">slced_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slices</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reduced</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">slced_dat</span><span class="p">,</span> <span class="s">&#39;size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># if we sliced the hell out of the array, just</span>
            <span class="c"># return the value that&#39;s left, ndarrays have the same behavior</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">slced_dat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">crds</span><span class="o">=</span><span class="n">crds</span><span class="p">)</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># if we sliced a vector down to one component</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_comps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">single_comp_slc</span><span class="p">:</span>
                    <span class="n">comp_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_COMPONENT_NAMES</span><span class="p">[</span><span class="n">comp_slc</span><span class="p">]</span>
                    <span class="n">ctx</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">comp_name</span>
                    <span class="n">ctx</span><span class="p">[</span><span class="s">&#39;pretty_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pretty_name</span> <span class="o">+</span>
                                          <span class="s">&quot;$_{0}$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_name</span><span class="p">))</span>
                    <span class="n">typ</span> <span class="o">=</span> <span class="s">&quot;Scalar&quot;</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">slced_dat</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="n">typ</span><span class="p">)</span>

            <span class="c"># if there are reduced dims, put them into the deep_meta dict</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reduced</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">[</span><span class="s">&quot;reduced&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduced</span>
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="Field.forget_source"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.forget_source">[docs]</a>    <span class="k">def</span> <span class="nf">forget_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</div>
<div class="viewcode-block" id="Field.slice"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.slice">[docs]</a>    <span class="k">def</span> <span class="nf">slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Slice the field using a string like &quot;y=3:6:2,z=0&quot; or a standard</span>
<span class="sd">        list of slice objects like one would give to numpy. In a string, i</span>
<span class="sd">        means by index, and bare numbers mean by the index closest to that</span>
<span class="sd">        value; see Coordinate.make_slice docs for an example. The semantics</span>
<span class="sd">        for keeping / droping dimensions are the same as for numpy arrays.</span>
<span class="sd">        This means selections that leave one crd in a given dimension reduce</span>
<span class="sd">        that dimension out. For other behavior see</span>
<span class="sd">        slice_reduce and slice_keep</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscentered</span><span class="p">(</span><span class="s">&quot;Cell&quot;</span><span class="p">)</span>
        <span class="n">selection</span><span class="p">,</span> <span class="n">comp_slc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_slice</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="n">slices</span><span class="p">,</span> <span class="n">crdlst</span><span class="p">,</span> <span class="n">reduced</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">make_slice</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">cc</span><span class="o">=</span><span class="n">cc</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_slice</span><span class="p">(</span><span class="n">slices</span><span class="p">,</span> <span class="n">crdlst</span><span class="p">,</span> <span class="n">reduced</span><span class="p">,</span> <span class="n">comp_slc</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Field.slice_reduce"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.slice_reduce">[docs]</a>    <span class="k">def</span> <span class="nf">slice_reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Slice the field, then go through all dims and look for dimensions</span>
<span class="sd">        with only one coordinate. Reduce those dimensions out of the new</span>
<span class="sd">        field &quot;&quot;&quot;</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscentered</span><span class="p">(</span><span class="s">&quot;Cell&quot;</span><span class="p">)</span>
        <span class="n">selection</span><span class="p">,</span> <span class="n">comp_slc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_slice</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="n">slices</span><span class="p">,</span> <span class="n">crdlst</span><span class="p">,</span> <span class="n">reduced</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">make_slice_reduce</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span>
                                                              <span class="n">cc</span><span class="o">=</span><span class="n">cc</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_slice</span><span class="p">(</span><span class="n">slices</span><span class="p">,</span> <span class="n">crdlst</span><span class="p">,</span> <span class="n">reduced</span><span class="p">,</span> <span class="n">comp_slc</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Field.slice_and_keep"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.slice_and_keep">[docs]</a>    <span class="k">def</span> <span class="nf">slice_and_keep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Slice the field, then go through dimensions that would be reduced</span>
<span class="sd">        by a normal numpy slice (like saying &#39;z=0&#39;) and keep those dimensions</span>
<span class="sd">        in the new field &quot;&quot;&quot;</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscentered</span><span class="p">(</span><span class="s">&quot;Cell&quot;</span><span class="p">)</span>
        <span class="n">selection</span><span class="p">,</span> <span class="n">comp_slc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_slice</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="n">slices</span><span class="p">,</span> <span class="n">crdlst</span><span class="p">,</span> <span class="n">reduced</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">make_slice_keep</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span>
                                                            <span class="n">cc</span><span class="o">=</span><span class="n">cc</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_slice</span><span class="p">(</span><span class="n">slices</span><span class="p">,</span> <span class="n">crdlst</span><span class="p">,</span> <span class="n">reduced</span><span class="p">,</span> <span class="n">comp_slc</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Field.set_slice"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.set_slice">[docs]</a>    <span class="k">def</span> <span class="nf">set_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Used for fld.__setitem__</span>

<span class="sd">        NOTE:</span>
<span class="sd">            This is only lightly tested</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscentered</span><span class="p">(</span><span class="s">&quot;Cell&quot;</span><span class="p">)</span>
        <span class="n">selection</span><span class="p">,</span> <span class="n">comp_slc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_slice</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="n">slices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">make_slice</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">cc</span><span class="o">=</span><span class="n">cc</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">slices</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_comp</span><span class="p">,</span> <span class="n">comp_slc</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slices</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Field.unload"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.unload">[docs]</a>    <span class="k">def</span> <span class="nf">unload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; does not guarentee that the memory will be freed &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_purge_cache</span><span class="p">()</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Field.istype"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.istype">[docs]</a>    <span class="k">def</span> <span class="nf">istype</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">type_str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_TYPE</span> <span class="o">==</span> <span class="n">type_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Field.iscentered"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.iscentered">[docs]</a>    <span class="k">def</span> <span class="nf">iscentered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center_str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">==</span> <span class="n">center_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Field.iter_points"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.iter_points">[docs]</a>    <span class="k">def</span> <span class="nf">iter_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c">#pylint: disable=W0613</span>
        <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">iter_points</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; unload the data &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; iterate though all values in the data, raveled &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">val</span>

    <span class="c">##################################</span>
    <span class="c">## Utility methods to get at crds</span>
    <span class="c"># these are the same as something like self._src_crds[&#39;xnc&#39;]</span>
    <span class="c"># or self._src_crds.get_crd()</span>
<div class="viewcode-block" id="Field.get_crd"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.get_crd">[docs]</a>    <span class="k">def</span> <span class="nf">get_crd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return crd along axis with same centering as field</span>
<span class="sd">        axis can be crd name as string, or index, as in x==2, y==1, z==2 &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">get_crd</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="n">shaped</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Field.get_crd_nc"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.get_crd_nc">[docs]</a>    <span class="k">def</span> <span class="nf">get_crd_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns a flat ndarray of coordinates along a given axis</span>
<span class="sd">        axis can be crd name as string, or index, as in x==2, y==1, z==2 &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">get_nc</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="n">shaped</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Field.get_crd_cc"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.get_crd_cc">[docs]</a>    <span class="k">def</span> <span class="nf">get_crd_cc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns a flat ndarray of coordinates along a given axis</span>
<span class="sd">        axis can be crd name as string, or index, as in x==2, y==1, z==2 &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">get_cc</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="n">shaped</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Field.get_crd_ec"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.get_crd_ec">[docs]</a>    <span class="k">def</span> <span class="nf">get_crd_ec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns a flat ndarray of coordinates along a given axis</span>
<span class="sd">        axis can be crd name as string, or index, as in x==2, y==1, z==2 &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">get_ec</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="n">shaped</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Field.get_crd_fc"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.get_crd_fc">[docs]</a>    <span class="k">def</span> <span class="nf">get_crd_fc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns a flat ndarray of coordinates along a given axis</span>
<span class="sd">        axis can be crd name as string, or index, as in x==2, y==1, z==2 &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">get_fc</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="n">shaped</span><span class="p">)</span>

    <span class="c">## these return all crd dimensions</span>
    <span class="c"># these are the same as something like self._src_crds.get_crds()</span></div>
<div class="viewcode-block" id="Field.get_crds"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.get_crds">[docs]</a>    <span class="k">def</span> <span class="nf">get_crds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return all crds as list of ndarrays with same centering as field &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">get_crds</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="n">shaped</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Field.get_crds_nc"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.get_crds_nc">[docs]</a>    <span class="k">def</span> <span class="nf">get_crds_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns all node centered coords as a list of ndarrays, flat if</span>
<span class="sd">        shaped==False, or shaped if shaped==True &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">get_crds_nc</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="n">shaped</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Field.get_crds_cc"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.get_crds_cc">[docs]</a>    <span class="k">def</span> <span class="nf">get_crds_cc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns all cell centered coords as a list of ndarrays, flat if</span>
<span class="sd">        shaped==False, or shaped if shaped==True &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">get_crds_cc</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="n">shaped</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Field.get_crds_fc"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.get_crds_fc">[docs]</a>    <span class="k">def</span> <span class="nf">get_crds_fc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns all face centered coords as a list of ndarrays, flat if</span>
<span class="sd">        shaped==False, or shaped if shaped==True &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">get_crds_fc</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="n">shaped</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Field.get_crds_ec"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.get_crds_ec">[docs]</a>    <span class="k">def</span> <span class="nf">get_crds_ec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns all edge centered coords as a list of ndarrays, flat if</span>
<span class="sd">        shaped==False, or shaped if shaped==True &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">get_crds_ec</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">shaped</span><span class="o">=</span><span class="n">shaped</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Field.is_spherical"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.is_spherical">[docs]</a>    <span class="k">def</span> <span class="nf">is_spherical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">is_spherical</span><span class="p">()</span>

    <span class="c">######################</span></div>
<div class="viewcode-block" id="Field.shell_copy"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.shell_copy">[docs]</a>    <span class="k">def</span> <span class="nf">shell_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a field just like this one with a new cache</span>

<span class="sd">        So, fields that belong to files are kept around for the</span>
<span class="sd">        lifetime of the file bucket, which is probably the lifetime</span>
<span class="sd">        of the main script. That means you have to explicitly unload</span>
<span class="sd">        to clear the cache (important if reading a timeseries of fields</span>
<span class="sd">        &gt; 1GB). This function will return a new field instance with</span>
<span class="sd">        references to all the same internals as self, except for the</span>
<span class="sd">        cache. Effectively, this turns the parent field into a</span>
<span class="sd">        lightweight &quot;field shell&quot;, from which a memory intensive field</span>
<span class="sd">        can be made on the fly.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            force(bool): without force, only make a new field if the</span>
<span class="sd">                cache is not already loaded. If set to True, a field&#39;s</span>
<span class="sd">                data could be in ram twice since _cache will be filled</span>
<span class="sd">                for the new field when needed. This is probably not what</span>
<span class="sd">                you want.</span>
<span class="sd">            kwargs: additional keyword arguments to give to the Field</span>
<span class="sd">                constructor</span>

<span class="sd">        Returns:</span>
<span class="sd">            a field as described above (could be self)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c"># Note: this is fragile if a subclass takes additional parameters</span>
        <span class="c"># in an overridden __init__; in that case, the developer MUST</span>
        <span class="c"># override shell_copy and pass the extra kwargs in to here.</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
                       <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="n">deep_meta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">,</span>
                       <span class="n">forget_source</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                       <span class="n">pretty_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pretty_name</span><span class="p">,</span>
                       <span class="n">post_reshape_transform_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post_reshape_transform_func</span><span class="p">,</span>
                       <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_func_kwargs</span><span class="p">,</span>
                       <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="p">],</span>
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="c">#####################</span>
    <span class="c">## convert centering</span>
    <span class="c"># Note: these are kind of specific to cartesian connected grids</span>
</div>
<div class="viewcode-block" id="Field.as_cell_centered"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.as_cell_centered">[docs]</a>    <span class="k">def</span> <span class="nf">as_cell_centered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert field to cell centered field without discarding</span>
<span class="sd">        any data; this goes through hacky pains to make sure the data</span>
<span class="sd">        is the same as self (including the state of cachedness)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscentered</span><span class="p">(</span><span class="s">&#39;cell&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscentered</span><span class="p">(</span><span class="s">&#39;node&#39;</span><span class="p">):</span>
            <span class="c"># construct new crds</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">axes</span>
            <span class="n">crds_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_crds_cc</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">crds_cc</span><span class="p">):</span>
                <span class="n">dxl</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dxh</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">crds_cc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dxl</span><span class="p">],</span>
                                             <span class="n">x</span><span class="p">,</span>
                                             <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dxh</span><span class="p">]])</span>
            <span class="n">new_clist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ax</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">nc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">crds_cc</span><span class="p">)]</span>
            <span class="n">new_crds</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="p">)(</span><span class="n">new_clist</span><span class="p">)</span>

            <span class="c"># this is similar to a shell copy, but it&#39;s intimately</span>
            <span class="c"># linked to self as a parent</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new_crds</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="s">&quot;cell&quot;</span><span class="p">,</span>
                           <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                           <span class="n">deep_meta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">,</span> <span class="n">forget_source</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                           <span class="n">pretty_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pretty_name</span><span class="p">,</span>
                           <span class="n">post_reshape_transform_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post_reshape_transform_func</span><span class="p">,</span>
                           <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_func_kwargs</span><span class="p">,</span>
                           <span class="n">_parent_field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="c">#FIME: this is such a hack to try our hardest to keep the</span>
            <span class="c"># reference to the data the same</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_src_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>

            <span class="k">return</span> <span class="n">f</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;can&#39;t yet move {0} to cell &quot;</span>
                                      <span class="s">&quot;centers&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="Field.as_node_centered"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.as_node_centered">[docs]</a>    <span class="k">def</span> <span class="nf">as_node_centered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert field to node centered field without discarding</span>
<span class="sd">        any data;  this goes through hacky pains to make sure the data</span>
<span class="sd">        is the same as self (including the state of cachedness)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscentered</span><span class="p">(</span><span class="s">&#39;node&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscentered</span><span class="p">(</span><span class="s">&#39;cell&#39;</span><span class="p">):</span>
            <span class="c"># construct new crds</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">axes</span>
            <span class="n">crds_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_crds_cc</span><span class="p">()</span>
            <span class="n">new_clist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ax</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">crds_cc</span><span class="p">)]</span>
            <span class="n">new_crds</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="p">)(</span><span class="n">new_clist</span><span class="p">)</span>

            <span class="c"># this is similar to a shell copy, but it&#39;s intimately</span>
            <span class="c"># linked to self as a parent</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new_crds</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="s">&quot;node&quot;</span><span class="p">,</span>
                           <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                           <span class="n">deep_meta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deep_meta</span><span class="p">,</span> <span class="n">forget_source</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                           <span class="n">pretty_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pretty_name</span><span class="p">,</span>
                           <span class="n">post_reshape_transform_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post_reshape_transform_func</span><span class="p">,</span>
                           <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_func_kwargs</span><span class="p">,</span>
                           <span class="n">_parent_field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="c">#FIME: this is such a hack to try our hardest to keep the</span>
            <span class="c"># reference to the data the same</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_src_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>

            <span class="k">return</span> <span class="n">f</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;can&#39;t yet move {0} to node &quot;</span>
                                      <span class="s">&quot;centers&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Field.as_c_contiguous"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.as_c_contiguous">[docs]</a>    <span class="k">def</span> <span class="nf">as_c_contiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Field with c-contiguous data</span>

<span class="sd">        Note:</span>
<span class="sd">            If the data is not already in memory (cached), this</span>
<span class="sd">            function will trigger a load.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Field or self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">was_loaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_loaded</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s">&#39;C_CONTIGUOUS&#39;</span><span class="p">]:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">was_loaded</span> <span class="ow">and</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="c">#######################</span>
    <span class="c">## emulate a container</span>
</div>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; just act as if you setitem on underlying data &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_slice</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; just act as if you delitem on underlying data, probably raises a</span>
<span class="sd">        ValueError &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="c">##########################</span>
    <span class="c">## emulate a numeric type</span>

    <span class="k">def</span> <span class="nf">__array__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># dtype = None is ok, datatype won&#39;t change</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<div class="viewcode-block" id="Field.wrap"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.wrap">[docs]</a>    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; arr is the data to wrap... context is exta deep_meta to pass</span>
<span class="sd">        to the constructor. The return is just a number if arr is a</span>
<span class="sd">        1 element ndarray, this is for ufuncs that reduce to a scalar &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="c"># if just 1 number wrappen in an array, unpack the value and</span>
        <span class="c"># return it... this is more ufuncy behavior</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">arr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">pretty_name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;pretty_name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretty_name</span><span class="p">)</span>
        <span class="n">crds</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;crds&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crds</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;center&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="c"># should it always return the same type as self?</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">field_type</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
        <span class="c"># Transform functions are intentionally omitted. The idea being that</span>
        <span class="c"># the transform was already applied when creating arr</span>
        <span class="k">return</span> <span class="n">typ</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">crds</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span>
                   <span class="n">meta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="n">deep_meta</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="p">],</span>
                   <span class="n">pretty_name</span><span class="o">=</span><span class="n">pretty_name</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__array_wrap__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_arr</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="c">#pylint: disable=W0613</span>
        <span class="c"># print(&quot;wrapping&quot;)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">out_arr</span><span class="p">)</span>

    <span class="c"># def __array_finalize__(self, *args, **kwargs):</span>
    <span class="c">#     print(&quot;attempted call to field.__array_finalize__&quot;)</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__sub__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__mul__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__div__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__truediv__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__floordiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__floordiv__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__mod__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__divmod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__divmod__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__pow__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__lshift__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__lshift__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__rshift__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__rshift__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__rshift__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__xor__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__rshift__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__rshift__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__radd__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__rsub__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__rmul__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__rdiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__rdiv__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__rtruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__rtruediv__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__rfloordiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__rfloordiv__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__rmod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__rmod__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__rdivmod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__rdivmod__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__rpow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__rpow__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>

    <span class="c"># inplace operations are not implemented since the data</span>
    <span class="c"># can up and disappear (due to unload)... this could cause</span>
    <span class="c"># confusion</span>
    <span class="k">def</span> <span class="nf">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">def</span> <span class="nf">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">def</span> <span class="nf">__imul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">def</span> <span class="nf">__idiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">def</span> <span class="nf">__itruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="c">#pylint: disable=R0201,W0613</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">def</span> <span class="nf">__ifloordiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="c">#pylint: disable=R0201,W0613</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">def</span> <span class="nf">__imod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">def</span> <span class="nf">__ipow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="nf">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__neg__</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">__pos__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__pos__</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">__abs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__abs__</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">__invert__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__invert__</span><span class="p">())</span>

<div class="viewcode-block" id="Field.any"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.any">[docs]</a>    <span class="k">def</span> <span class="nf">any</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">any</span><span class="p">()</span></div>
<div class="viewcode-block" id="Field.all"><a class="viewcode-back" href="../../viscid.html#viscid.field.Field.all">[docs]</a>    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__lt__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__le__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__ne__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__gt__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__ge__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="ScalarField"><a class="viewcode-back" href="../../viscid.html#viscid.field.ScalarField">[docs]</a><span class="k">class</span> <span class="nc">ScalarField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">_TYPE</span> <span class="o">=</span> <span class="s">&quot;scalar&quot;</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="ScalarField.nr_dims"><a class="viewcode-back" href="../../viscid.html#viscid.field.ScalarField.nr_dims">[docs]</a>    <span class="k">def</span> <span class="nf">nr_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_sdims</span>

    <span class="c"># FIXME: there is probably a better way to deal with scalars not</span>
    <span class="c"># having a component dimension</span></div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="ScalarField.nr_comp"><a class="viewcode-back" href="../../viscid.html#viscid.field.ScalarField.nr_comp">[docs]</a>    <span class="k">def</span> <span class="nf">nr_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Scalars have no components&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="ScalarField.nr_comps"><a class="viewcode-back" href="../../viscid.html#viscid.field.ScalarField.nr_comps">[docs]</a>    <span class="k">def</span> <span class="nf">nr_comps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="c"># no downsample / transpose / swap axes for vectors yet since that would</span>
    <span class="c"># have the added layer of checking the layout</span></div>
<div class="viewcode-block" id="ScalarField.downsample"><a class="viewcode-back" href="../../viscid.html#viscid.field.ScalarField.downsample">[docs]</a>    <span class="k">def</span> <span class="nf">downsample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; downsample the spatial dimensions by a factor of 2 &quot;&quot;&quot;</span>
        <span class="c"># FIXME: this implementation assumes a lot about the field</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sshape</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_sdims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">downdat</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">dat</span><span class="p">[:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_sdims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">downdat</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">dat</span><span class="p">[:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                              <span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                              <span class="n">dat</span><span class="p">[:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                              <span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_sdims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">downdat</span> <span class="o">=</span> <span class="mf">0.125</span> <span class="o">*</span> <span class="p">(</span><span class="n">dat</span><span class="p">[:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                               <span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                               <span class="n">dat</span><span class="p">[:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                               <span class="n">dat</span><span class="p">[:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                               <span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                               <span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                               <span class="n">dat</span><span class="p">[:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                               <span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">downclist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">get_clist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">downcrds</span> <span class="o">=</span> <span class="n">coordinate</span><span class="o">.</span><span class="n">wrap_crds</span><span class="p">(</span><span class="s">&quot;nonuniform_cartesian&quot;</span><span class="p">,</span> <span class="n">downclist</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">downdat</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;crds&quot;</span><span class="p">:</span> <span class="n">downcrds</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="ScalarField.transpose"><a class="viewcode-back" href="../../viscid.html#viscid.field.ScalarField.transpose">[docs]</a>    <span class="k">def</span> <span class="nf">transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">axes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; same behavior as numpy transpose, alse accessable</span>
<span class="sd">        using np.transpose(fld) &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">axes</span> <span class="o">==</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_dims</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_dims</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;transpose can not change number of axes&quot;</span><span class="p">)</span>
        <span class="n">clist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">get_clist</span><span class="p">()</span>
        <span class="n">new_clist</span> <span class="o">=</span> <span class="p">[</span><span class="n">clist</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
        <span class="n">t_crds</span> <span class="o">=</span> <span class="n">coordinate</span><span class="o">.</span><span class="n">wrap_crds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">new_clist</span><span class="p">)</span>
        <span class="n">t_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">t_data</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;crds&quot;</span><span class="p">:</span> <span class="n">t_crds</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="ScalarField.swap_axes"><a class="viewcode-back" href="../../viscid.html#viscid.field.ScalarField.swap_axes">[docs]</a>    <span class="k">def</span> <span class="nf">swap_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">new_clist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">get_clist</span><span class="p">()</span>
        <span class="n">new_clist</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">new_clist</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_clist</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">new_clist</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="n">new_crds</span> <span class="o">=</span> <span class="n">coordinate</span><span class="o">.</span><span class="n">wrap_crds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_crds</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">new_clist</span><span class="p">)</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">swap_axes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;crds&quot;</span><span class="p">:</span> <span class="n">new_crds</span><span class="p">})</span>

</div></div>
<div class="viewcode-block" id="VectorField"><a class="viewcode-back" href="../../viscid.html#viscid.field.VectorField">[docs]</a><span class="k">class</span> <span class="nc">VectorField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">_TYPE</span> <span class="o">=</span> <span class="s">&quot;vector&quot;</span>
    <span class="n">_COMPONENT_NAMES</span> <span class="o">=</span> <span class="s">&quot;xyzuvw&quot;</span>

<div class="viewcode-block" id="VectorField.component_views"><a class="viewcode-back" href="../../viscid.html#viscid.field.VectorField.component_views">[docs]</a>    <span class="k">def</span> <span class="nf">component_views</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return numpy views to components individually, memory layout</span>
<span class="sd">        of the original field is maintained &quot;&quot;&quot;</span>
        <span class="n">flds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_fields</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flds</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="VectorField.component_fields"><a class="viewcode-back" href="../../viscid.html#viscid.field.VectorField.component_fields">[docs]</a>    <span class="k">def</span> <span class="nf">component_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_FLAT</span> <span class="ow">and</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span>
            <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span><span class="p">])):</span>
            <span class="c"># if all elements are fields</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_data</span>

        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_comps</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_comps</span><span class="p">):</span>
            <span class="n">slc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">slc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">lst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">slc</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lst</span>
</div>
<div class="viewcode-block" id="VectorField.as_interlaced"><a class="viewcode-back" href="../../viscid.html#viscid.field.VectorField.as_interlaced">[docs]</a>    <span class="k">def</span> <span class="nf">as_interlaced</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_c_contiguous</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an interlaced version of this field</span>

<span class="sd">        Note:</span>
<span class="sd">            This will trigger a data load if the data is not already</span>
<span class="sd">            in memory</span>

<span class="sd">        Args:</span>
<span class="sd">            force_c_contiguous: if data is not c contiguous, then wrap</span>
<span class="sd">                it in another np.array() call.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self, or Field if</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">was_loaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_loaded</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_INTERLACED</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force_c_contiguous</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s">&#39;C_CONTIGUOUS&#39;</span><span class="p">]:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;calling np.ascontiguousarray&quot;</span><span class="p">)</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;returning self&quot;</span><span class="p">)</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">force_layout</span><span class="o">=</span><span class="n">LAYOUT_INTERLACED</span><span class="p">)</span>
            <span class="c"># the data load is going to wrap the array, i think it&#39;s</span>
            <span class="c"># redundant to put an &quot;ascontiguousarray&quot; here</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">was_loaded</span> <span class="ow">and</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span>
</div></div>
<div class="viewcode-block" id="MatrixField"><a class="viewcode-back" href="../../viscid.html#viscid.field.MatrixField">[docs]</a><span class="k">class</span> <span class="nc">MatrixField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">_TYPE</span> <span class="o">=</span> <span class="s">&quot;matrix&quot;</span>

</div>
<div class="viewcode-block" id="TensorField"><a class="viewcode-back" href="../../viscid.html#viscid.field.TensorField">[docs]</a><span class="k">class</span> <span class="nc">TensorField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">_TYPE</span> <span class="o">=</span> <span class="s">&quot;tensor&quot;</span>


<span class="c">##</span>
<span class="c">## EOF</span>
<span class="c">##</span></div>
</pre></div>

          <footer>
  <hr/>

  <p>
      &copy; Copyright 2013, Kristofor Maynard.
  </p>

  <a href="https://www.github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="http://www.readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  

</body>
</html>